{% extends "malware_insights/base.html" %}

{% block title %}Analysis of {{ filename }}{% endblock %}

{% block content %}
<h2 class="mb-4">Analysis of <code>{{ filename }}</code></h2>
<div class="container mt-4">

<h3>File Level Information</h3>

  <!-- Button group stays on one line -->
  <div class="btn-group mb-3" role="group" aria-label="Toggle sections">
    <button
      id="btn-header"
      type="button"
      class="btn btn-outline-info active"
      onclick="toggleSection('header')">
      Header Info
    </button>
    <button
      id="btn-matches"
      type="button"
      class="btn btn-outline-warning"
      onclick="toggleSection('matches')">
      Overall Matches
    </button>
    <button
      id="btn-entropy"
      type="button"
      class="btn btn-outline-primary"
      onclick="toggleSection('entropy')">
      Entropy
    </button>
    <button
      id="btn-strings"
      type="button"
      class="btn btn-outline-secondary"
      onclick="toggleSection('strings')">
      Strings
    </button>
  </div>
  
  <!-- Panels -->
  <div id="header" class="card border-info mb-3"  style="max-height: 500px; overflow-y: auto;">
    <ul class="list-group" id="headerInfo"></ul>
  </div>
  
  <div id="matches" class="card border-warning mb-3" style="max-height: 500px; overflow-y: auto;">
    <ul class="list-group" id="matchList"></ul>
  </div>
  
  <div id="entropy" class="card border-primary mb-3" style="max-height: 500px; overflow-y: auto;">
    <ul class="list-group" id="entropyList"></ul>
  </div>
  
  <div id="strings" class="card border-secondary mb-3" style="max-height: 500px; overflow-y: auto;">
    <ul class="list-group" id="stringsList"></ul>
  </div>
  
  <script>
    async function loadJson(path) {
      const res = await fetch(path);
      if (!res.ok) throw new Error(`Failed to load ${path}: ${res.status}`);
      return await res.json();
    }
  
    function toggleSection(section) {
      const panels = {
        header:  document.getElementById('header'),
        matches: document.getElementById('matches'),
        entropy: document.getElementById('entropy'),
        strings: document.getElementById('strings'),
      };
  
      const buttons = {
        header:  document.getElementById('btn-header'),
        matches: document.getElementById('btn-matches'),
        entropy: document.getElementById('btn-entropy'),
        strings: document.getElementById('btn-strings'),
      };
  
      // which solid class to use for each
      const solidClass = {
        header:  'btn-info',
        matches: 'btn-warning',
        entropy: 'btn-primary',
        strings: 'btn-secondary',
      };
  
      // 1) hide all panels & reset all buttons
      for (let key of Object.keys(panels)) {
        panels[key].style.display = 'none';
        buttons[key].classList.remove('active', solidClass[key]);
        buttons[key].classList.add(`btn-outline-${solidClass[key].slice(4)}`);
      }
  
      // 2) show the requested panel & mark button active
      panels[section].style.display = 'block';
      buttons[section].classList.add('active', solidClass[section]);
      buttons[section].classList.remove(`btn-outline-${solidClass[section].slice(4)}`);
  
      // 3) render content for that section
      switch (section) {
        case 'header': {
          const data = JSON.parse(document.getElementById('headerJSON').textContent);
          const ul   = document.getElementById('headerInfo');
          ul.innerHTML = '';
          for (let [k,v] of Object.entries(data)) {
            let li = document.createElement('li');
            li.className = 'list-group-item';
            li.textContent = `${k}: ${v}`;
            ul.appendChild(li);
          }
          break;
        }
        case 'matches': {
          const data = JSON.parse(document.getElementById('matchJSON').textContent);
          const ul   = document.getElementById('matchList');
          ul.innerHTML = '';
          for (let item of data) {
            let li = document.createElement('li');
            li.className = 'list-group-item';
            li.textContent = item;
            ul.appendChild(li);
          }
          break;
        }
        case 'entropy': {
          const data = JSON.parse(
            document.getElementById('entropyJSON').textContent
          );
          const ul = document.getElementById('entropyList');
          ul.innerHTML = '';
          for (let [sec, val] of Object.entries(data)) {
            let li = document.createElement('li');
            li.className = 'list-group-item';
            li.textContent = `${sec}: ${val.toFixed(2)} bits/byte`;
            ul.appendChild(li);
          }
          break;
        }

        case 'strings': {
          const data = JSON.parse(
            document.getElementById('stringsJSON').textContent
          );
          const ul = document.getElementById('stringsList');
          ul.innerHTML = '';
          for (let s of data) {
            let li = document.createElement('li');
            li.className = 'list-group-item';
            li.textContent = s;
            ul.appendChild(li);
          }
          break;
        }
      }
    }
  
    // render the default panel on page‐load
    window.addEventListener('DOMContentLoaded', () => toggleSection('header'));
  </script>
  
  <!-- your existing JSON‐injection for header & matches -->
  {{ match_list|json_script:"matchJSON" }}
  {{ header_info|json_script:"headerJSON" }}
  {{ entropy_data | json_script:"entropyJSON" }}
  {{ strings_data | json_script:"stringsJSON" }}
  
  

  <h3>Function Level Information</h3>
  <!-- Functions section (if you have one) -->
  <div class="container">
    <!-- 1) List of functions -->
    <ul id="functionList" class="list-group mb-4" style="max-height: 500px; overflow-y: auto;">
      {% for func in functions %}
        <li class="list-group-item">
          <a href="#"
             onclick="showFunction('{{ func.name|slugify }}'); return false;">
            {{ func.name }}
          </a>
        </li>
      {% endfor %}
    </ul>
  
    <!-- 2) Detail panel -->
    <div class="row">
      <div class="col-md-5">
        <h5>Matched Rules</h5>
        <div class="card border-warning mb-3">
          <ul class="list-group" id="ruleBox"></ul>
        </div>
      </div>
      <div class="col-md-7">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 id="panelLabel">Disassembly</h5>
          <div>
            <button class="btn btn-sm btn-outline-success"
                    onclick="togglePanel('dis')">
              Disassembly
            </button>
            <button class="btn btn-sm btn-outline-success"
                    onclick="togglePanel('hlil')">
              HLIL
            </button>
          </div>
        </div>
        <div class="card border-success mb-3"
        style="max-height:500px; overflow-y:auto;">
        <p class="card-text">
        <pre id="panelContent">
        </pre>
        </p>
      </div>
        
      </div>
    </div>
  
    <!-- 3) Hidden JSON blobs -->
    {% for func in functions %}
      {% with slugged=func.name|slugify %}
        {% with script_id="func_"|add:slugged %}
          {{ func|json_script:script_id }}
        {% endwith %}
      {% endwith %}
    {% endfor %}
  </div>
  
  
  <script>
    let currentFunc = null;
  
    function showFunction(name) {
      const funcScript = document.getElementById("func_" + name);
      if (!funcScript) return console.error("Missing script:", name);
  
      const funcData = JSON.parse(funcScript.textContent);
      currentFunc = funcData;
  
      // rules
      const ruleBox = document.getElementById("ruleBox");
      ruleBox.innerHTML = "";
      (funcData.rules || []).forEach(r => {
        const li = document.createElement("li");
        li.className = "list-group-item";
        li.textContent = r;
        ruleBox.appendChild(li);
      });
  
      // default to disasm
      document.getElementById("panelLabel").textContent =
        `Disassembly for ${funcData.name} (${funcData.address})`;
      document.getElementById("panelContent").textContent =
        (funcData.disassembly || []).join("\n");
    }
  
    function togglePanel(type) {
      if (!currentFunc) return;
      const label = document.getElementById("panelLabel");
      const content = document.getElementById("panelContent");
  
      if (type === "dis") {
        label.textContent = `Disassembly for ${currentFunc.name} (${currentFunc.address})`;
        content.textContent = (currentFunc.disassembly || []).join("\n");
      } else {
        label.textContent = `High‑Level IL for ${currentFunc.name} (${currentFunc.address})`;
        const hlil = currentFunc.hlil
              || currentFunc.high_level_IL
              || [];
        panelContent.textContent = hlil.join("\n");
      }
    }
  
    // if you want to auto‑load the first function on page‑load:
    window.addEventListener("DOMContentLoaded", () => {
      const first = document.querySelector("#functionList a");
      if (first) first.click();
    });
  </script>
  
  
{% endblock %}
