{% extends "malware_insights/base.html" %}

{% block title %}Analysis of {{ filename }}{% endblock %}

{% block content %}
<h2 class="mb-4">Analysis of <code>{{ filename }}</code></h2>
<div class="container mt-4">

  <h3>VirusTotal Score</h3>
  <div class="{{ vt_class }}" style="max-width: 90px;">
      <strong>{{ positives }}/{{ total }}</strong>
  </div>
  

<h3>File Level Information</h3>

  <!-- Button group stays on one line -->
  <div class="btn-group mb-3" role="group" aria-label="Toggle sections">
    <button
      id="btn-header"
      type="button"
      class="btn btn-outline-info active"
      onclick="toggleSection('header')">
      Header Info
    </button>
    <button
      id="btn-matches"
      type="button"
      class="btn btn-outline-warning"
      onclick="toggleSection('matches')">
      Overall Matches
    </button>
    <button
      id="btn-entropy"
      type="button"
      class="btn btn-outline-primary"
      onclick="toggleSection('entropy')">
      Entropy
    </button>
    <button
      id="btn-strings"
      type="button"
      class="btn btn-outline-secondary"
      onclick="toggleSection('strings')">
      Strings
    </button>
  </div>
  
  <!-- Panels -->
  <div id="header" class="card border-info mb-3"  style="max-height: 500px; overflow-y: auto;">
    <ul class="list-group">
      {% for k,v in header_info.items %}
      <li class="list-group-item">{{ k }}: {{ v }}</li>
      {% endfor %}
    </ul>
  </div>
  
  <div id="matches" class="card border-warning mb-3" style="max-height: 500px; overflow-y: auto;">
    <ul class="list-group">
      {% for m in match_list %}
      <li class="list-group-item">{{ m }}</li>
      {% endfor %}
    </ul>
  </div>
  
  <div id="entropy" class="card border-primary mb-3" style="max-height: 500px; overflow-y: auto;">
    <ul class="list-group">
      {% for sec, val in entropy_data.items %}
      <li class="list-group-item">{{ sec }}: {{ val|floatformat:2 }} bits/byte</li>
      {% endfor %}
    </ul>
  </div>
  
  <div id="strings" class="card border-secondary mb-3" style="max-height: 500px; overflow-y: auto;">
    <ul class="list-group">
      {% for s in strings_data %}
      <li class="list-group-item">{{ s }}</li>
      {% endfor %}
    </ul>
  </div>

  <!-- Hide all panels by default -->
  <script>
    const sections = ['header', 'matches', 'entropy', 'strings'];
    sections.forEach(section => {
      document.getElementById(section).style.display = 'none';
      document.getElementById('btn-' + section).classList.remove('active');
    });
    // Show the header section by default
    document.getElementById('header').style.display = 'block';
    document.getElementById('btn-header').classList.add('active');
  
    function toggleSection(section) {
      sections.forEach(sec => {
        const el = document.getElementById(sec);
        const btn = document.getElementById('btn-' + sec);
        if (sec === section) {
          el.style.display = 'block';
          btn.classList.add('active');
        } else {
          el.style.display = 'none';
          btn.classList.remove('active');
        }
      });
    }
  </script>
  

  <h3>Function Level Information</h3>
  <!-- Functions section (if you have one) -->
  <div class="container">
    <!-- 1) List of functions -->
    <ul id="functionList" class="list-group mb-4" style="max-height: 500px; overflow-y: auto;">
      {% for func in functions %}
        <li class="list-group-item">
          <a href="#"
             onclick="showFunction('{{ func.name|slugify }}'); return false;">
            {{ func.name }}
          </a>
        </li>
      {% endfor %}
    </ul>
  
    <!-- 2) Detail panel -->
    <div class="row">
      <div class="col-md-5">
        <h5>Matched Rules</h5>
        <div class="card border-warning mb-3">
          <ul class="list-group" id="ruleBox"></ul>
        </div>
      </div>
      <div class="col-md-7">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 id="panelLabel">Disassembly</h5>
          <div>
            <button class="btn btn-sm btn-outline-success"
                    onclick="togglePanel('dis')">
              Disassembly
            </button>
            <button class="btn btn-sm btn-outline-success"
                    onclick="togglePanel('hlil')">
              HLIL
            </button>
          </div>
        </div>
        <div class="card border-success mb-3"
        style="max-height:500px; overflow-y:auto;">
        <p class="card-text">
        <pre id="panelContent">
        </pre>
        </p>
      </div>
        
      </div>
    </div>
  
    <!-- 3) Hidden JSON blobs -->
    {% for func in functions %}
      {% with slugged=func.name|slugify %}
        {% with script_id="func_"|add:slugged %}
          {{ func|json_script:script_id }}
        {% endwith %}
      {% endwith %}
    {% endfor %}
  </div>
  
  
  <script>
    let currentFunc = null;
  
    function showFunction(name) {
      const funcScript = document.getElementById("func_" + name);
      if (!funcScript) return console.error("Missing script:", name);
  
      const funcData = JSON.parse(funcScript.textContent);
      currentFunc = funcData;
  
      // rules
      const ruleBox = document.getElementById("ruleBox");
      ruleBox.innerHTML = "";
      (funcData.rules || []).forEach(r => {
        const li = document.createElement("li");
        li.className = "list-group-item";
        li.textContent = r;
        ruleBox.appendChild(li);
      });
  
      // default to disasm
      document.getElementById("panelLabel").textContent =
        `Disassembly for ${funcData.name} (${funcData.address})`;
      document.getElementById("panelContent").textContent =
        (funcData.disassembly || []).join("\n");
    }
  
    function togglePanel(type) {
      if (!currentFunc) return;
      const label = document.getElementById("panelLabel");
      const content = document.getElementById("panelContent");
  
      if (type === "dis") {
        label.textContent = `Disassembly for ${currentFunc.name} (${currentFunc.address})`;
        content.textContent = (currentFunc.disassembly || []).join("\n");
      } else {
        label.textContent = `High‑Level IL for ${currentFunc.name} (${currentFunc.address})`;
        const hlil = currentFunc.hlil
              || currentFunc.high_level_IL
              || [];
        panelContent.textContent = hlil.join("\n");
      }
    }
  
    // if you want to auto‑load the first function on page‑load:
    window.addEventListener("DOMContentLoaded", () => {
      const first = document.querySelector("#functionList a");
      if (first) first.click();
    });
  </script>
  
  
{% endblock %}
