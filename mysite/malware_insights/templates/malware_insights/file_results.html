{% extends "malware_insights/base.html" %}

{% block title %}Analysis of {{ filename }}{% endblock %}

{% block content %}
<h2 class="mb-4">Analysis of <code>{{ filename }}</code></h2>
<div class="container mt-4">

  <!-- Button group stays on one line -->
  <div class="btn-group mb-3" role="group" aria-label="Toggle sections">
    <button
    id="btn-header"
    type="button"
    class="btn btn-outline-primary active"
    onclick="toggleSection('header')">
    Header Info
  </button>
    <button
      id="btn-matches"
      type="button"
      class="btn btn-outline-primary"
      onclick="toggleSection('matches')">
      Overall Matches
    </button>

  </div>

  <!-- Panels -->
  <div id="matches" class="card card-body bg-light mb-3">
    <ul class="list-group" id="matchList"></ul>
  </div>
  <div id="header" class="card card-body bg-light" style="display: none;">
    <ul class="list-group" id="headerInfo"></ul>
  </div>
</div>


{{ match_list|json_script:"matchJSON" }}
{{ header_info  | json_script:"headerJSON" }}

<script>
  function toggleSection(section) {
    // panel elements
    const panels = {
      matches: document.getElementById('matches'),
      header:  document.getElementById('header')
    };
  
    // button elements
    const buttons = {
      matches: document.getElementById('btn-matches'),
      header:  document.getElementById('btn-header')
    };
  
    // 1) hide all panels, remove active on all buttons
    Object.values(panels).forEach(p => p.style.display = 'none');
    Object.values(buttons).forEach(b => b.classList.remove('active', 'btn-primary'));
  
    // 2) show the requested panel
    panels[section].style.display = 'block';
  
    // 3) mark the clicked button active
    buttons[section].classList.add('active', 'btn-primary');
    buttons[section].classList.remove('btn-outline-primary');
  
    // 4) render its contents
    if (section === 'header') {
      const data = JSON.parse(document.getElementById('headerJSON').textContent);
      const ul   = document.getElementById('headerInfo');
      ul.innerHTML = '';
      Object.entries(data).forEach(([k,v]) => {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.textContent = `${k}: ${v}`;
        ul.appendChild(li);
      });
      
    } else {
      const data = JSON.parse(document.getElementById('matchJSON').textContent);
      const ul   = document.getElementById('matchList');
      ul.innerHTML = '';
      data.forEach(item => {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.textContent = item;
        ul.appendChild(li);
      });
    }
  }
  
  // optional: on page‐load, render the default “matches”
  window.addEventListener('DOMContentLoaded', () => toggleSection('header'));
  </script>
  


  <!-- Functions section (if you have one) -->
  <div class="container">
    <!-- 1) List of functions -->
    <ul id="functionList" class="list-group mb-4">
      {% for func in functions %}
        <li class="list-group-item">
          <a href="#"
             onclick="showFunction('{{ func.name|slugify }}'); return false;">
            {{ func.name }}
          </a>
        </li>
      {% endfor %}
    </ul>
  
    <!-- 2) Detail panel -->
    <div class="row">
      <div class="col-md-5">
        <h5>Matched Rules</h5>
        <ul class="list-group" id="ruleBox"></ul>
      </div>
      <div class="col-md-7">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 id="panelLabel">Disassembly</h5>
          <div>
            <button class="btn btn-sm btn-outline-secondary"
                    onclick="togglePanel('dis')">
              Disassembly
            </button>
            <button class="btn btn-sm btn-outline-secondary"
                    onclick="togglePanel('hlil')">
              HLIL
            </button>
          </div>
        </div>
        <pre id="panelContent"
             class="bg-light p-3 border rounded"
             style="max-height:500px; overflow-y:auto;">
        </pre>
      </div>
    </div>
  
    <!-- 3) Hidden JSON blobs -->
    {% for func in functions %}
      {% with slugged=func.name|slugify %}
        {% with script_id="func_"|add:slugged %}
          {{ func|json_script:script_id }}
        {% endwith %}
      {% endwith %}
    {% endfor %}
  </div>
  
  
  <script>
    let currentFunc = null;
  
    function showFunction(name) {
      const funcScript = document.getElementById("func_" + name);
      if (!funcScript) return console.error("Missing script:", name);
  
      const funcData = JSON.parse(funcScript.textContent);
      currentFunc = funcData;
  
      // rules
      const ruleBox = document.getElementById("ruleBox");
      ruleBox.innerHTML = "";
      (funcData.rules || []).forEach(r => {
        const li = document.createElement("li");
        li.className = "list-group-item";
        li.textContent = r;
        ruleBox.appendChild(li);
      });
  
      // default to disasm
      document.getElementById("panelLabel").textContent =
        `Disassembly for ${funcData.name} (${funcData.address})`;
      document.getElementById("panelContent").textContent =
        (funcData.disassembly || []).join("\n");
    }
  
    function togglePanel(type) {
      if (!currentFunc) return;
      const label = document.getElementById("panelLabel");
      const content = document.getElementById("panelContent");
  
      if (type === "dis") {
        label.textContent = `Disassembly for ${currentFunc.name} (${currentFunc.address})`;
        content.textContent = (currentFunc.disassembly || []).join("\n");
      } else {
        label.textContent = `High‑Level IL for ${currentFunc.name} (${currentFunc.address})`;
        const hlil = currentFunc.hlil
              || currentFunc.high_level_IL
              || [];
        panelContent.textContent = hlil.join("\n");
      }
    }
  
    // if you want to auto‑load the first function on page‑load:
    window.addEventListener("DOMContentLoaded", () => {
      const first = document.querySelector("#functionList a");
      if (first) first.click();
    });
  </script>
  
  
{% endblock %}
